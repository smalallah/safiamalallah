<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CV Object Builder + CV Renderer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="root"></div>

  <!-- React + ReactDOM + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // Colors inspired by your CV theme (purple accents)
    const ACCENT = "#6B21A8"; // deep purple 800
    const LIGHT_ACCENT = "#F3E8FF"; // light purple bg

    const CATEGORY_OPTIONS = [
      "Education & Credentials",
      "Academic Positions",
      "Industry Experience",
      "Grants & Funding",
      "Publications",
      "Developed Tools & Educational Resources",
      "Workshops, Seminars & Panels",
      "Teaching Experience",
      "Application Development Projects",
      "Academic Committees & Service",
      "Professional & Community Memberships",
      "Conference & Event Participation",
      "Student Supervision",
      "Collaborations & Partnerships",
      "Collaboration Opportunities",
      "Awards & Recognitions",
    ];

    const DEFAULT_ROLE_OPTIONS = [
      "Instructor","Organizer","Panelist","Presenter","Author","Co-PI","PI",
      "Advisor","Reviewer","Member","Developer","Designer","Researcher",
    ];

    // ---------- Utils ----------
    const slugify = (text="") => text.toString().toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)+/g,"");
    const todayISO = () => {
      const d = new Date(); const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60*1000);
      return local.toISOString().slice(0,10);
    };
    const downloadJSON = (filename, data) => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    };
    const readJSONFile = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => { try { resolve(JSON.parse(reader.result)); } catch(e){ reject(e); } };
      reader.onerror = reject; reader.readAsText(file);
    });

    // ---------- Reusable Inputs ----------
    function ChipInput({ label, placeholder, values, setValues }) {
      const [input, setInput] = useState("");
      return (
        <div className="flex flex-col gap-2">
          <label className="text-sm font-medium">{label}</label>
          <div className="flex gap-2">
            <input className="flex-1 rounded-xl border px-3 py-2 outline-none focus:ring-2"
              placeholder={placeholder} value={input}
              onChange={(e)=>setInput(e.target.value)}
              onKeyDown={(e)=>{ if((e.key==="Enter"||e.key===",") && input.trim()){ e.preventDefault(); if(!values.includes(input.trim())) setValues([...values, input.trim()]); setInput(""); }}}/>
            <button type="button" className="rounded-xl px-4 py-2 border shadow-sm"
              onClick={()=>{ if(input.trim() && !values.includes(input.trim())) setValues([...values, input.trim()]); setInput(""); }}>Add</button>
          </div>
          {values?.length>0 && (
            <div className="flex flex-wrap gap-2">
              {values.map(v=> (
                <span key={v} className="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-sm">
                  {v}
                  <button type="button" className="opacity-60 hover:opacity-100" onClick={()=>setValues(values.filter(x=>x!==v))}>×</button>
                </span>
              ))}
            </div>
          )}
        </div>
      );
    }

    function MultiSelect({ label, options, selected, setSelected }) {
      const [query, setQuery] = useState("");
      const filtered = useMemo(()=> options.filter(o=>o.toLowerCase().includes(query.toLowerCase())), [options, query]);
      return (
        <div className="flex flex-col gap-2">
          <label className="text-sm font-medium">{label}</label>
          <input className="rounded-xl border px-3 py-2 outline-none focus:ring-2" placeholder="Search..." value={query} onChange={(e)=>setQuery(e.target.value)} />
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 max-h-52 overflow-auto rounded-xl border p-2">
            {filtered.map(o=>{
              const active = selected.includes(o);
              return (
                <button type="button" key={o}
                  onClick={()=> setSelected(active ? selected.filter(x=>x!==o) : [...selected, o])}
                  className={"text-left rounded-lg px-3 py-2 border " + (active ? "ring-2 ring-purple-600" : "hover:bg-gray-50")}>
                  {o}
                </button>
              );
            })}
          </div>
          {selected.length>0 && (
            <div className="flex flex-wrap gap-2">
              {selected.map(v=> (
                <span key={v} className="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-sm">
                  {v}
                  <button type="button" className="opacity-60 hover:opacity-100" onClick={()=>setSelected(selected.filter(x=>x!==v))}>×</button>
                </span>
              ))}
            </div>
          )}
        </div>
      );
    }

    // ---------- Builder Page ----------
    function Builder({ objects, setObjects, byCategory, setByCategory }){
      const [title, setTitle] = useState("");
      const [description, setDescription] = useState("");
      const [dateStart, setDateStart] = useState(todayISO());
      const [dateEnd, setDateEnd] = useState("");
      const [isCurrent, setIsCurrent] = useState(false);
      const [location, setLocation] = useState("");
      const [organization, setOrganization] = useState("");
      const [roles, setRoles] = useState([]);
      const [categories, setCategories] = useState([]);
      const [tags, setTags] = useState([]);
      const [links, setLinks] = useState([]);
      const [notes, setNotes] = useState("");
      const [roleOptions, setRoleOptions] = useState(DEFAULT_ROLE_OPTIONS);
      const [customRole, setCustomRole] = useState("");

      const resetForm = () => {
        setTitle(""); setDescription(""); setDateStart(todayISO()); setDateEnd(""); setIsCurrent(false);
        setLocation(""); setOrganization(""); setRoles([]); setCategories([]); setTags([]); setLinks([]); setNotes("");
      };

      const addObject = () => {
        if(!title.trim()) return alert("Title is required.");
        if(categories.length===0) return alert("Please select at least one category.");
        const id = `${dateStart || todayISO()}-${slugify(title)}-${Date.now().toString().slice(-5)}`;
        const obj = {
          id, title: title.trim(), description: description.trim(),
          date_start: dateStart || null,
          date_end: isCurrent ? "Present" : (dateEnd || null),
          location: location.trim() || null,
          organization: organization.trim() || null,
          roles: roles.length? roles : null,
          categories: [...categories],
          tags: tags.length? tags : null,
          links: links.length? links : null,
          notes: notes.trim() || null,
          current: isCurrent || false,
        };
        const newObjects = [obj, ...objects];
        setObjects(newObjects);
        const map = { ...byCategory };
        categories.forEach(c=>{ if(!map[c]) map[c]=[]; map[c] = [obj, ...map[c]]; });
        setByCategory(map);
        resetForm();
      };

      const handleImport = async (e, kind) => {
        const file = e.target.files?.[0]; if(!file) return;
        try {
          const json = await readJSONFile(file);
          if(kind==="objects"){
            const merged = [...objects]; const ids = new Set(merged.map(o=>o.id));
            (json||[]).forEach(o=>{ if(!ids.has(o.id)) merged.push(o); });
            setObjects(merged.sort((a,b)=> (b.date_start||"").localeCompare(a.date_start||"")));
          } else if (kind==="byCategory"){
            setByCategory({ ...(byCategory||{}), ...(json||{}) });
          }
        } catch { alert("Invalid JSON"); }
      };

      const exportAll = () => {
        downloadJSON("cv_objects.json", objects);
        downloadJSON("cv_by_category.json", byCategory);
      };

      const categoriesCount = useMemo(()=> Object.fromEntries(CATEGORY_OPTIONS.map(c=>[c,(byCategory[c]||[]).length])), [byCategory]);

      return (
        <div className="mx-auto max-w-6xl px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
          <section className="lg:col-span-2">
            <div className="rounded-2xl bg-white p-4 md:p-6 shadow-sm border">
              <h2 className="text-xl font-semibold mb-4">Create a New Object</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="flex flex-col gap-2 md:col-span-2">
                  <label className="text-sm font-medium">Title *</label>
                  <input className="rounded-xl border px-3 py-2 outline-none focus:ring-2" placeholder="e.g., CS for Elementary Learners Workshop" value={title} onChange={(e)=>setTitle(e.target.value)} />
                </div>
                <div className="flex flex-col gap-2 md:col-span-2">
                  <label className="text-sm font-medium">Description</label>
                  <textarea className="rounded-xl border px-3 py-2 outline-none focus:ring-2 min-h-[100px]" placeholder="A one or two sentence summary for the CV." value={description} onChange={(e)=>setDescription(e.target.value)} />
                </div>
                <div className="flex flex-col gap-2">
                  <label className="text-sm font-medium">Start Date</label>
                  <input type="date" className="rounded-xl border px-3 py-2" value={dateStart} onChange={(e)=>setDateStart(e.target.value)} />
                </div>
                <div className="flex flex-col gap-2">
                  <label className="text-sm font-medium">End Date</label>
                  <div className="flex items-center gap-2">
                    <input type="date" className="rounded-xl border px-3 py-2 flex-1" value={dateEnd} onChange={(e)=>setDateEnd(e.target.value)} disabled={isCurrent} />
                    <label className="flex items-center gap-1 text-sm">
                      <input type="checkbox" checked={isCurrent} onChange={(e)=>{ setIsCurrent(e.target.checked); if(e.target.checked) setDateEnd("Present"); else setDateEnd(""); }} /> Current
                    </label>
                  </div>
                </div>
                <div className="flex flex-col gap-2">
                  <label className="text-sm font-medium">Location</label>
                  <input className="rounded-xl border px-3 py-2" placeholder="City, State, Country" value={location} onChange={(e)=>setLocation(e.target.value)} />
                </div>
                <div className="flex flex-col gap-2">
                  <label className="text-sm font-medium">Organization</label>
                  <input className="rounded-xl border px-3 py-2" placeholder="Institution or company name" value={organization} onChange={(e)=>setOrganization(e.target.value)} />
                </div>

                <div className="md:col-span-2">
                  <MultiSelect label="Roles (choose any)" options={roleOptions} selected={roles} setSelected={setRoles} />
                  <div className="mt-3 flex gap-2 items-center">
                    <input className="rounded-xl border px-3 py-2" placeholder="Add custom role (e.g., Co-chair)" value={customRole} onChange={(e)=>setCustomRole(e.target.value)} />
                    <button type="button" className="rounded-xl border px-4 py-2" onClick={()=>{
                      const r = (customRole||"").trim(); if(!r) return;
                      if(!roleOptions.includes(r)) setRoleOptions([...roleOptions, r]);
                      if(!roles.includes(r)) setRoles([...roles, r]); setCustomRole("");
                    }}>Add Role</button>
                  </div>
                </div>

                <div className="md:col-span-2">
                  <MultiSelect label="Categories *" options={CATEGORY_OPTIONS} selected={categories} setSelected={setCategories} />
                </div>

                <div className="md:col-span-2">
                  <ChipInput label="Tags" placeholder="Type a tag and press Enter (e.g., K-5, Python, NSF)" values={tags} setValues={setTags} />
                </div>
                <div className="md:col-span-2">
                  <ChipInput label="Links" placeholder="Paste a URL and press Enter (e.g., https://doi.org/...)" values={links} setValues={setLinks} />
                </div>

                <div className="flex flex-col gap-2 md:col-span-2">
                  <label className="text-sm font-medium">Private Notes</label>
                  <textarea className="rounded-xl border px-3 py-2 outline-none focus:ring-2 min-h-[80px]" placeholder="Internal notes only (not for CV rendering)." value={notes} onChange={(e)=>setNotes(e.target.value)} />
                </div>
              </div>
              <div className="mt-6 flex flex-wrap items-center gap-3">
                <button onClick={addObject} className="rounded-2xl px-5 py-2.5 bg-black text-white shadow-md">Add Object</button>
                <button onClick={resetForm} className="rounded-2xl px-5 py-2.5 border">Reset</button>
                <div className="text-sm text-gray-600">* Required fields</div>
              </div>
            </div>
          </section>

          <aside className="space-y-6">
            <div className="rounded-2xl bg-white p-4 md:p-6 shadow-sm border">
              <h3 className="text-lg font-semibold mb-3">Category Counts</h3>
              <div className="grid grid-cols-1 gap-2 max-h-[360px] overflow-auto pr-1">
                {CATEGORY_OPTIONS.map(c=> (
                  <div key={c} className="flex items-center justify-between gap-3 border rounded-xl px-3 py-2">
                    <span className="text-sm">{c}</span>
                    <span className="text-xs rounded-full border px-2 py-0.5">{(byCategory[c]||[]).length}</span>
                  </div>
                ))}
              </div>
            </div>

            <div className="rounded-2xl bg-white p-4 md:p-6 shadow-sm border">
              <h3 className="text-lg font-semibold mb-3">Latest Objects</h3>
              <div className="space-y-3 max-h-[360px] overflow-auto pr-1">
                {objects.length===0 && <p className="text-sm text-gray-500">Nothing yet. Add your first object from the form.</p>}
                {objects.map(o=>(
                  <div key={o.id} className="rounded-xl border p-3">
                    <div className="text-sm font-medium">{o.title}</div>
                    <div className="text-xs text-gray-600">{o.date_start}{o.date_end ? ` → ${o.date_end}` : ""}</div>
                    <div className="mt-1 text-xs">{(o.categories||[]).join(", ")}</div>
                  </div>
                ))}
              </div>
            </div>

            <div className="rounded-2xl bg-white p-4 md:p-6 shadow-sm border">
              <h3 className="text-lg font-semibold mb-3">Import / Export</h3>
              <div className="flex flex-col gap-2">
                <label className="cursor-pointer rounded-xl border px-3 py-2 bg-white shadow-sm text-sm">Import objects.json
                  <input type="file" className="hidden" accept="application/json" onChange={(e)=>handleImport(e,"objects")} />
                </label>
                <label className="cursor-pointer rounded-xl border px-3 py-2 bg-white shadow-sm text-sm">Import by_category.json
                  <input type="file" className="hidden" accept="application/json" onChange={(e)=>handleImport(e,"byCategory")} />
                </label>
                <button onClick={exportAll} className="w-full rounded-2xl px-5 py-2.5 bg-black text-white shadow-md">Download JSONs</button>
              </div>
            </div>
          </aside>
        </div>
      );
    }

    // ---------- CV Renderer Page ----------
    function CVRenderer({ objects, byCategory, setObjects, setByCategory }){
      const [loaded, setLoaded] = useState(false);

      const handleImportObjects = async (e) => {
        const file = e.target.files?.[0]; if(!file) return;
        try {
          const json = await readJSONFile(file);
          const merged = [...objects]; const ids = new Set(merged.map(o=>o.id));
          (json||[]).forEach(o=>{ if(!ids.has(o.id)) merged.push(o); });
          setObjects(merged.sort((a,b)=> (b.date_start||"").localeCompare(a.date_start||"")));
          setLoaded(true);
        } catch { alert("Invalid JSON"); }
      };

      const buildCategoryMap = useMemo(()=> {
        if (Object.keys(byCategory||{}).length) return byCategory;
        // Build from objects if byCategory is empty
        const map = {}; (objects||[]).forEach(o=> (o.categories||[]).forEach(c=>{ if(!map[c]) map[c]=[]; map[c].push(o); }));
        return map;
      }, [objects, byCategory]);

      const Section = ({ title, items }) => {
        if(!items || items.length===0) return null;
        return (
          <section className="mb-6">
            <h3 className="text-lg font-semibold mb-2" style={{color: ACCENT}}>{title}</h3>
            <div className="space-y-3">
              {items.map((o)=> (
                <div key={o.id} className="rounded-xl border p-3 bg-white">
                  <div className="flex flex-wrap items-baseline justify-between gap-2">
                    <div className="font-medium">{o.title}</div>
                    <div className="text-xs text-gray-600">{o.date_start}{o.date_end? ` – ${o.date_end}`: ""}</div>
                  </div>
                  {o.organization && <div className="text-sm text-gray-700">{o.organization}{o.location? ` — ${o.location}`: ""}</div>}
                  {o.description && <p className="text-sm mt-1">{o.description}</p>}
                  {o.roles && <div className="text-xs mt-1"><span className="font-medium">Roles:</span> {(o.roles||[]).join(", ")}</div>}
                  {o.links && <div className="text-xs mt-1 space-x-2">{(o.links||[]).map((L,i)=>(<a key={i} href={L} className="underline" target="_blank" rel="noreferrer">Link {i+1}</a>))}</div>}
                </div>
              ))}
            </div>
          </section>
        );
      };

      return (
        <div className="mx-auto max-w-4xl px-4 py-6">
          <div className="no-print mb-4 flex items-center justify-between">
            <div className="text-sm text-gray-600">Load your <code>objects.json</code> if needed.</div>
            <label className="cursor-pointer rounded-xl border px-3 py-2 bg-white shadow-sm text-sm">Import objects.json
              <input type="file" className="hidden" accept="application/json" onChange={handleImportObjects} />
            </label>
          </div>

          {/* Header block */}
          <div className="rounded-2xl border p-6 bg-white">
            <h1 className="text-3xl font-bold" style={{color: ACCENT}}>Safia A. Malallah</h1>
            <p className="text-sm text-gray-700 mt-1">Learning Scientist / Computer Science Educator</p>
          </div>

          {/* Sections in a CV-like order */}
          <div className="mt-6">
            <Section title="Education" items={buildCategoryMap["Education & Credentials"]} />
            <Section title="Academic Experience" items={buildCategoryMap["Academic Positions"]} />
            <Section title="Industry Experience" items={buildCategoryMap["Industry Experience"]} />
            <Section title="Grants & Funding" items={buildCategoryMap["Grants & Funding"]} />
            <Section title="Publications" items={buildCategoryMap["Publications"]} />
            <Section title="Developed Tools & Educational Resources" items={buildCategoryMap["Developed Tools & Educational Resources"]} />
            <Section title="Workshops, Colloquia, and Seminars" items={buildCategoryMap["Workshops, Seminars & Panels"]} />
            <Section title="Teaching Experience" items={buildCategoryMap["Teaching Experience"]} />
            <Section title="Application Development Experience" items={buildCategoryMap["Application Development Projects"]} />
            <Section title="Academic Committees & Service" items={buildCategoryMap["Academic Committees & Service"]} />
            <Section title="Professional & Community Memberships" items={buildCategoryMap["Professional & Community Memberships"]} />
            <Section title="Conference & Event Participation" items={buildCategoryMap["Conference & Event Participation"]} />
            <Section title="Student Supervision" items={buildCategoryMap["Student Supervision"]} />
            <Section title="Collaborations & Partnerships" items={buildCategoryMap["Collaborations & Partnerships"]} />
            <Section title="Collaboration Opportunities" items={buildCategoryMap["Collaboration Opportunities"]} />
            <Section title="Awards & Recognitions" items={buildCategoryMap["Awards & Recognitions"]} />
          </div>

          <div className="no-print mt-8 flex items-center justify-end gap-3">
            <button className="rounded-2xl px-5 py-2.5 border" onClick={()=>window.scrollTo({top:0, behavior:'smooth'})}>Back to Top</button>
            <button className="rounded-2xl px-5 py-2.5" style={{background: "#000", color: "#fff"}} onClick={() => window.print()}>Print / Save PDF</button>
          </div>
        </div>
      );
    }

    // ---------- App Shell with Menu ----------
    function App(){
      const [page, setPage] = useState("builder");
      const [objects, setObjects] = useState([]);
      const [byCategory, setByCategory] = useState({});

      // persist
      useEffect(()=>{
        const saved = localStorage.getItem("cv_object_builder_data");
        if(saved){ try{ const parsed = JSON.parse(saved); setObjects(parsed.objects||[]); setByCategory(parsed.byCategory||{});} catch{} }
      },[]);
      useEffect(()=>{
        localStorage.setItem("cv_object_builder_data", JSON.stringify({ objects, byCategory }));
      },[objects, byCategory]);

      return (
        <div>
          <nav className="no-print sticky top-0 z-20 bg-white/80 backdrop-blur border-b">
            <div className="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2.5 h-6 rounded-full" style={{background: ACCENT}}></div>
                <span className="font-semibold">CV Builder</span>
              </div>
              <div className="flex gap-2">
                <button onClick={()=>setPage("builder")} className={"rounded-xl px-4 py-2 border " + (page==="builder"?"bg-[color:var(--tw-prose-invert)] ring-2 ring-purple-600":"")}>Builder</button>
                <button onClick={()=>setPage("cv")} className={"rounded-xl px-4 py-2 border " + (page==="cv"?"ring-2 ring-purple-600":"")}>CV</button>
              </div>
            </div>
          </nav>

          {page==="builder"
            ? <Builder objects={objects} setObjects={setObjects} byCategory={byCategory} setByCategory={setByCategory} />
            : <CVRenderer objects={objects} byCategory={byCategory} setObjects={setObjects} setByCategory={setByCategory} />
          }
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
